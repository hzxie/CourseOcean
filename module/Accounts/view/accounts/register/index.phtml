<?php 
    echo $this->headTitle('注册 | ');
    echo $this->headLink()->appendStylesheet($this->basePath().'/css/accounts/register.css');
?>

<div id="header">
    <ul class="inline">
        <li>已有账户? <a href="<?php echo $this->basePath(); ?>/accounts/login">立即登录</a></li>
    </ul>
</div> <!-- #header -->
<div id="container">
    <div class="container">
        <div id="logo">
            <a href="#">
                <img src="<?php echo $this->basePath(); ?>/img/logo.png" alt="Logo">
            </a>
        </div>
        <div id="content" class="row-fluid">
            <div id="tab-nav" class="span3">
                <div class="tab active">
                    <div class="tab-label">个人用户</div>
                    <div class="nav-arrow"></div>
                </div> <!-- .tab -->
                <div class="tab">
                    <div class="tab-label">讲师用户</div>
                    <div class="nav-arrow"></div>
                </div> <!-- .tab -->
                <div class="tab">
                    <div class="tab-label">企业用户</div>
                    <div class="nav-arrow"></div>
                </div> <!-- .tab -->
            </div> <!-- #tab-nav -->
            <div id="tab-content" class="span9">
                <div class="content-node active">
                    <div class="row-fluid">
                        <div class="span7"><img src="<?php echo $this->basePath(); ?>/img/accounts/register-tab-1.jpg" alt="Tab Content"></div><!-- .span8 -->
                        <div class="span5 register-form">
                            <h4>创建您的账户</h4>
                            <span>用户类型: 个人用户</span>
                            <input id="username" name="username" type="text" placeholder="用户名(以字母开头, 6-16个字符)" maxlength="16" />
                            <input id="email" name="email" type="text" placeholder="电子邮件地址" maxlength="64" />
                            <input id="password" name="password" type="password" placeholder="密码(6-16个字符)" maxlength="16" />
                            <input id="password-again" name="password-again" type="password" placeholder="确认密码" maxlength="16" />
                        </div>
                    </div> <!-- .row-fluid -->
                </div> <!-- .content-node -->
            </div> <!-- #tab-content -->
        </div> <!-- .row-fluid -->
    </div> <!-- .container -->
</div> <!-- #container -->

<?php $this->inlineScript()->captureStart(); ?>
    $('#register').click(function() {
        var postData = getPostData();
        setInputStyle(true);
        doRegisterAction(postData);
    });
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function getPostData() {
        var postData    = '';
        $(':input').each(function() {
            var key     = $(this).attr('name'),
                value   = $(this).val();
            if ( typeof key != 'undefined' && value != '' ) {
                postData += '&' + key + '=' + value;
            }
        });

        return postData;
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function setInputStyle(isLoading) {
        var registerButtonObject = $('#register');
        if ( isLoading ) {
            registerButtonObject.html('正在创建您的账户...');
            $('input').attr('disabled', 'disabled');
            $('select').attr('disabled', 'disabled');
            $('button').attr('disabled', 'disabled');
        } else {
            registerButtonObject.html('登录');
            $('input').removeAttr('disabled');
            $('select').removeAttr('disabled');
            $('button').removeAttr('disabled');
        }
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function doRegisterAction(postData) {
        var userGroup   = $('select#user-group-selector').val();
        if ( userGroup == '' ) {
            return;
        }

        $.ajax({
            type: 'POST',
            async: false,
            url: '<?php echo $this->basePath(); ?>/accounts/register/process',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                processResult(result, userGroup);
            }
        });
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function processResult(result, userGroup) {
        if ( result['isSuccessful'] ) {
            return doVerifyEmailAction();
        }

        var errorMessage = '';
        errorMessage     = onErrorHandler(result, userGroup);

        $('#register-error').html(errorMessage);
        $('#register-error').fadeIn();
        $('html, body').animate({ scrollTop: 0 }, 'slow');

        setInputStyle(false);
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function doVerifyEmailAction() {
        window.location.href='<?php echo $this->basePath(); ?>/accounts/register/email';
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function onErrorHandler(result, userGroup) {
        var errorMessage  = '';
        if ( result['isUsernameEmpty'] ) {
            errorMessage += '用户名为必填字段<br />';
        } else if ( !result['isUsernameLegal'] ) {
            errorMessage += '用户名必须以字母开头, 长度须在6-16个字符之间<br />';
        } else if ( result['isUsernameExists'] ) {
            errorMessage += '用户名已被他人占用, 请使用其他用户名<br />';
        }
        if ( result['isEmailEmpty'] ) {
            errorMessage += '电子邮件地址为必填字段<br />';
        } else if ( !result['isEmailLegal'] ) {
            errorMessage += '请填写合法的电子邮件地址<br />';
        } else if ( result['isEmailExists'] ) {
            errorMessage += '该电子邮件地址已被使用, 请使用其他电子邮件地址<br />';
        }
        if ( result['isPasswordEmpty'] ) {
            errorMessage += '请填写您的密码<br />';
        } else if ( !result['isPasswordLegal'] ) {
            errorMessage += '密码必须在6-16个字符之间<br />';
        }
        if ( result['isConfirmPasswordEmpty'] ) {
            errorMessage += '请确认您的密码<br />';
        } else if ( !result['isConfirmPasswordMatched'] ) {
            errorMessage += '密码与确认密码输入不一致<br />';
        }
        if ( !result['isUserGroupLegal'] ) {
            errorMessage += '您所选择的用户组不合法<br />';
        }

        return errorMessage;
    }
<?php $this->inlineScript()->captureEnd(); ?>