<?php 
    echo $this->headTitle('完成注册 | ');
    echo $this->headLink()->appendStylesheet($this->basePath().'/css/accounts/complete.css');
    echo $this->headScript()->appendFile($this->basePath().'/js/citypicker.js');
?>

<div id="content">
    <div id="banner">
        <div id="banner-content">
            <h2>完成注册</h2>
            <h4>请完善您的个人资料以完成注册</h4>
        </div> <!-- #banner-content -->
    </div> <!-- #banner -->
    <div id="main-container" class="row">
    	<div class="span8">
            <div id="error" class="span6 alert alert-error hide"></div> <!-- #error -->
            <div class="section">
                <label for="username">用户名</label>
                <input id="username" class="span6" type="text" value="<?php echo $username; ?>" disabled="disabled"/><br />
                <span>您无法在注册后修改您的用户名</span>
            </div> <!-- .section -->
            <?php if ( $userGroupSlug == 'Person' || $userGroupSlug == 'Teacher' ): ?>
                <div class="section">
                    <label for="real-name">真实姓名</label>
                    <input id="real-name" class="span6" type="text" maxlength="16" /><br />
                    <?php if ( $userGroupSlug == 'Person' ): ?>
                        <span>请提供您的真实姓名以便报名参加课程</span>
                    <?php elseif ( $userGroupSlug == 'Teacher' ): ?>
                        <span>请提供您的真实姓名以便让更多用户找到您</span>
                    <?php endif; ?>
                </div> <!-- .section -->
            <?php elseif ( $userGroupSlug == 'Company' ): ?>
                <div class="section">
                    <label for="company-name">公司名称</label>
                    <input id="company-name" class="span6" type="text" maxlength="64" /><br />
                    <span>请提供您公司的名称以便报名参加课程</span>
                </div> <!-- .section -->
            <?php endif; ?>
            <div class="section">
                <label for="region">所在地区</label>
                <form action="#">
                    <select onchange="setProvince(this, province, city)" id="region" name="region" />
                        <option value="" selected>任意地区</option>
                        <script type="text/javascript">setRegions();</script>
                    </select>
                    <select id="province" disabled="disabled" onchange="setCity(this, city)"></select>
                    <select id="city" disabled="disabled"></select>
                </form>
                <span>请提供您的所在的城市以便我们为您推荐课程</span>
            </div> <!-- .section -->
            <?php if ( $userGroupSlug == 'Company' ): ?>
                <div class="section">
                    <label for="address">公司地址</label>
                    <input id="address" class="span6" type="text" maxlength="128" /><br />
                    <span>请提供您公司的地址以便讲师为您授课</span>
                </div> <!-- .section -->
            <?php endif; ?>
            <?php if ( $userGroupSlug == 'Person' ): ?>
                <div class="section">
                    <label for="work-position">工作职位</label>
                    <select id="work-position" class="span6">
                    <?php foreach ( $workPositions as $position ) { ?>
                        <option value="<?php echo $position->position_slug; ?>"><?php echo $position->position_name; ?></option>
                    <?php } ?>
                    </select><br />
                    <span>请选择您的工作职位以便我们为您推荐课程</span>
                </div> <!-- .section -->
            <?php elseif ( $userGroupSlug == 'Teacher' ): ?>
                <div class="section">
                    <label for="teaching-field">授课领域(最多选择3项)</label>
                    <select id="teaching-field" multiple="multiple">
                    <?php foreach ( $courseTypes as $courseType ) { ?>
                        <option value="<?php echo $courseType->course_type_slug; ?>"><?php echo $courseType->course_type_name; ?></option>
                    <?php } ?>
                    </select><br />
                    <span>请选择您的授课领域以便让更多人了解您</span>
                </div> <!-- .section -->
                <div class="section">
                    <label for="company">所在公司及职位</label>
                    <input id="company" class="span6" type="text" maxlength="64" /><br />
                    <span>请填写您所在的(或曾经就职的)公司职位以便让更多人了解您</span>
                </div> <!-- .section -->
            <?php elseif ( $userGroupSlug == 'Company' ): ?>
                <div class="section">
                    <label for="company-field">公司行业</label>
                    <select id="company-field" class="span6">
                        <option value=""></option>
                        <option value="计算机硬件及网络设备">计算机硬件及网络设备</option>
                        <option value="计算机软件">计算机软件</option>
                        <option value="IT服务（系统/数据/维护）/多领域经营">IT服务（系统/数据/维护）/多领域经营</option>
                        <option value="互联网/电子商务">互联网/电子商务</option>
                        <option value="网络游戏">网络游戏</option>
                        <option value="通讯（设备/运营/增值服务）">通讯（设备/运营/增值服务）</option>
                        <option value="电子技术/半导体/集成电路">电子技术/半导体/集成电路</option>
                        <option value="仪器仪表及工业自动化">仪器仪表及工业自动化</option>
                        <option value="金融/银行/投资/基金/证券">金融/银行/投资/基金/证券</option>
                        <option value="保险">保险</option>
                        <option value="房地产/建筑/建材/工程">房地产/建筑/建材/工程</option>
                        <option value="家居/室内设计/装饰装潢">家居/室内设计/装饰装潢</option>
                        <option value="物业管理/商业中心">物业管理/商业中心</option>
                        <option value="广告/会展/公关/市场推广">广告/会展/公关/市场推广</option>
                        <option value="媒体/出版/影视/文化/艺术">媒体/出版/影视/文化/艺术</option>
                        <option value="印刷/包装/造纸">印刷/包装/造纸</option>
                        <option value="咨询/管理产业/法律/财会">咨询/管理产业/法律/财会</option>
                        <option value="教育/培训">教育/培训</option>
                        <option value="检验/检测/认证">检验/检测/认证</option>
                        <option value="中介服务">中介服务</option>
                        <option value="贸易/进出口">贸易/进出口</option>
                        <option value="零售/批发">零售/批发</option>
                        <option value="快速消费品（食品/饮料/烟酒/化妆品">快速消费品（食品/饮料/烟酒/化妆品</option>
                        <option value="耐用消费品（服装服饰/纺织/皮革/家具/家电）">耐用消费品（服装服饰/纺织/皮革/家具/家电）</option>
                        <option value="办公用品及设备">办公用品及设备</option>
                        <option value="礼品/玩具/工艺美术/收藏品">礼品/玩具/工艺美术/收藏品</option>
                        <option value="大型设备/机电设备/重工业">大型设备/机电设备/重工业</option>
                        <option value="加工制造（原料加工/模具）">加工制造（原料加工/模具）</option>
                        <option value="汽车/摩托车（制造/维护/配件/销售/服务）">汽车/摩托车（制造/维护/配件/销售/服务）</option>
                        <option value="交通/运输/物流">交通/运输/物流</option>
                        <option value="医药/生物工程">医药/生物工程</option>
                        <option value="医疗/护理/美容/保健">医疗/护理/美容/保健</option>
                        <option value="医疗设备/器械">医疗设备/器械</option>
                        <option value="酒店/餐饮">酒店/餐饮</option>
                        <option value="娱乐/体育/休闲">娱乐/体育/休闲</option>
                        <option value="旅游/度假">旅游/度假</option>
                        <option value="石油/石化/化工">石油/石化/化工</option>
                        <option value="能源/矿产/采掘/冶炼">能源/矿产/采掘/冶炼</option>
                        <option value="电气/电力/水利">电气/电力/水利</option>
                        <option value="航空/航天">航空/航天</option>
                        <option value="学术/科研">学术/科研</option>
                        <option value="政府/公共事业/非盈利机构">政府/公共事业/非盈利机构</option>
                        <option value="环保">环保</option>
                        <option value="农/林/牧/渔">农/林/牧/渔</option>
                        <option value="跨领域经营">跨领域经营</option>
                        <option value="其它">其它</option>
                    </select><br />
                    <span>请选择贵公司的行业以便讲师对您有一定了解</span>
                </div> <!-- .section -->
                <div class="section">
                    <label for="company-scale">公司规模</label>
                    <select id="company-scale" class="span6">
                        <option value=""></option>
                        <option value="10">1~10人</option>
                        <option value="100">10~100人</option>
                        <option value="1000">100~1000人</option>
                        <option value="10000">1000~10000人</option>
                        <option value="32767">10000人以上</option>
                    </select><br />
                    <span>请选择贵公司的规模以便讲师对您有一定了解</span>
                </div> <!-- .section -->
            <?php endif; ?>
            <?php if ( $userGroupSlug == 'Person' || $userGroupSlug == 'Teacher' ): ?>
                <div class="section">
                    <label for="mobile-phone">移动电话</label>
                    <input id="mobile-phone" class="span6" type="text" maxlength="16" /><br />
                    <span>请提供您的联系方式以便在报名后我们与您联系</span>
                </div> <!-- .section -->
            <?php elseif ( $userGroupSlug == 'Company' ): ?>
                <div class="section">
                    <label for="phone">联系电话</label>
                    <input id="phone" class="span6" type="text" maxlength="24" /><br />
                    <span>请提供您公司的电话以便我们与您取得联系</span>
                </div> <!-- .section -->
            <?php endif; ?>
            <?php if ( $userGroupSlug == 'Teacher' ): ?>
                <div class="section">
                    <label for="weibo">新浪微博(非必填项)</label>
                    <input id="weibo" class="span6" type="text" maxlength="32" /><br />
                    <span>您可以提供您的新浪微博以便让更多人了解您</span>
                </div> <!-- .section -->
            <?php endif; ?>
            <div id="controls" class="section span6 text-right">
                <button id="complete-profile" class="btn btn-primary">确认</button>
                <button class="btn">取消</button>
            </div> <!-- .section -->
        </div> <!-- .span8 -->
        <div class="span4">
            <h4>完善个人资料</h4>
            <p>请完善您的个人资料, 以便我们更好地为您推荐课程.</p>
        </div>
    </div> <!-- #main-container -->
</div> <!-- #content -->

<?php $this->inlineScript()->captureStart(); ?>
    $('#teaching-field').click(function() {
        var selectedItems   = 0,
            optionLength    = $('select#teaching-field option').length;
        
        for ( var i = 0; i < optionLength; ++ i ) {
            var optionObject = $('#teaching-field option')[i];
            optionObject.selected ? ++ selectedItems : null;

            if ( selectedItems > 3 ) {
                optionObject.selected = false;
            }
        }
    });
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    $('#complete-profile').click(function() {
        var postData = getPostData();
        setInputStyle(true);
        doCompleteProfileAction(postData);
    });
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function getPostData() {
        var postData    = '';

        $('input').each(function() {
            var key     = $(this).attr('id'),
                value   = $(this).val();
            postData   += '&' + key + '=' + value;
        });
        $('select').each(function() {
            var key     = $(this).attr('id'),
                value   = $(this).val();
            postData   += '&' + key + '=' + ( value == null ? '' : value );
        });
        return postData;
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function setInputStyle(isLoading) {
        var registerButtonObject = $('#complete-profile');
        if ( isLoading ) {
            registerButtonObject.html('正在处理...');
            $('input').attr('disabled', 'disabled');
            $('select').attr('disabled', 'disabled');
            $('button').attr('disabled', 'disabled');
        } else {
            registerButtonObject.html('确认');
            $('input').removeAttr('disabled');
            $('select').removeAttr('disabled');
            $('button').removeAttr('disabled');
        }
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function doCompleteProfileAction(postData) {
        $.ajax({
            type: 'POST',
            async: false,
            url: '<?php echo $this->basePath(); ?>/accounts/register/processCompleteProfile',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                processResult(result);
            }
        });
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function processResult(result) {
        if ( result['isSuccessful'] ) {
            return doDashboardAction();
        } else {
            return errorHandler(result);
        }
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function doDashboardAction() {
        window.location.href='<?php echo $this->basePath(); ?>/accounts/dashboard';
    }
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->inlineScript()->captureStart(); ?>
    function errorHandler(result) {
        var errorMessage = '';
<?php if ( $userGroupSlug == 'Person' ): ?>
        if ( result['isPersonNameEmpty'] ) {
            errorMessage += '请填写您的真实姓名<br />';
        } else if ( !result['isPersonNameLegal'] ) {
            errorMessage += '您的姓名不能超过32个字符<br />';
        }
        if ( result['isPersonRegionEmpty'] ) {
            errorMessage += '请选择您所在的地区<br />';
        }
        if ( result['isPersonProvinceEmpty'] ) {
            errorMessage += '请选择您所在的省份<br />';
        }
        if ( result['isPersonCityEmpty'] ) {
            errorMessage += '请选择您所在的城市<br />';
        }
        if ( !result['isWorkPositionLegal'] ) {
            errorMessage += '请选择您的工作职位<br />';
        }
        if ( result['isPersonPhoneEmpty'] ) {
            errorMessage += '请填写您的移动电话<br />';
        } else if ( !result['isPersonPhoneLegal'] ) {
            errorMessage += '请填写正确的移动电话<br />';
        }
<?php elseif ( $userGroupSlug == 'Teacher' ): ?>
        if ( result['isTeacherNameEmpty'] ) {
            errorMessage += '请填写您的真实姓名<br />';
        } else if ( !result['isTeacherNameLegal'] ) {
            errorMessage += '您的姓名不能超过32个字符<br />';
        }
        if ( result['isTeacherRegionEmpty'] ) {
            errorMessage += '请选择您所在的地区<br />';
        }
        if ( result['isTeacherProvinceEmpty'] ) {
            errorMessage += '请选择您所在的省份<br />';
        }
        if ( result['isTeacherCityEmpty'] ) {
            errorMessage += '请选择您所在的城市<br />';
        }
        if ( result['isTeachingFieldEmpty'] || !result['isTeachingFieldLegal'] ) {
            errorMessage += '请选择您的授课领域<br />';
        }
        if ( result['isCompanyNameEmpty'] ) {
            errorMessage += '请填写您的所在的(或曾经就职的)公司<br />';
        } else if ( !result['isCompanyNameLegal'] ) {
            errorMessage += '您所填写的公司名称不能超过64个字符<br />';
        }
        if ( result['isTeacherPhoneEmpty'] ) {
            errorMessage += '请填写您的移动电话<br />';
        } else if ( !result['isTeacherPhoneLegal'] ) {
            errorMessage += '请填写正确的移动电话<br />';
        }
        if ( !result['isTeacherWeiboLegal'] ) {
            errorMessage += '您的微博账号不能超过32个字符<br />';
        }
<?php elseif ( $userGroupSlug == 'Company' ): ?>
        if ( result['isCompanyNameEmpty'] ) {
            errorMessage += '请填写贵公司的名称<br />';
        } else if ( !result['isCompanyNameLegal'] ) {
            errorMessage += '公司名称不能超过64个字符<br />';
        }
        if ( result['isCompanyRegionEmpty'] ) {
            errorMessage += '请选择贵公司所在的地区<br />';
        }
        if ( result['isCompanyProvinceEmpty'] ) {
            errorMessage += '请选择贵公司所在的省份<br />';
        }
        if ( result['isCompanyCityEmpty'] ) {
            errorMessage += '请选择贵公司所在的城市<br />';
        }
        if ( result['isCompanyAddressEmpty'] ) {
            errorMessage += '请填写贵公司的地址<br />';
        } else if ( !result['isCompanyAddressLegal'] ) {
            errorMessage += '公司地址不能超过256个字符<br />';
        }
        if ( result['isCompanyFieldEmpty'] || !result['isCompanyFieldLegal'] ) {
            errorMessage += '请选择贵公司的行业领域<br />';
        }
        if ( result['isCompanyScaleEmpty'] || !result['isCompanyScaleLegal'] ) {
            errorMessage += '请选择贵公司的规模<br />';
        }
        if ( result['isCompanyPhoneEmpty'] ) {
            errorMessage += '请填写贵公司的联系电话<br />';
        } else if ( !result['isCompanyPhoneLegal'] ) {
            errorMessage += '请填写正确的联系电话<br />';
        }
<?php endif; ?>
        $('#error').html(errorMessage);
        $('#error').fadeIn();
        
        scrollToTop();
        setInputStyle(false);
    }
<?php $this->inlineScript()->captureEnd(); ?>